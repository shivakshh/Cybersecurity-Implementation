<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SecureVault{% endblock %}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            margin-bottom: 30px;
            border-radius: 15px;
        }

        .header h1 {
            color: white;
            text-align: center;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2c3e50);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-google {
            background: #db4437;
        }

        .btn-github {
            background: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: 500;
        }

        .alert-error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }

        .alert-success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
        }

        .alert-info {
            background: #eef;
            border: 1px solid #ccf;
            color: #33c;
        }

        .mfa-setup {
            text-align: center;
        }

        .qr-code {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 15px;
            display: inline-block;
        }

        .qr-code img {
            max-width: 200px;
            height: auto;
        }

        /* Notepad Styles */
        .notepad-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: auto 1fr;
            gap: 0;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }

        .notepad-header {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            margin: 0;
        }

        .note-controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .note-info {
            font-size: 12px;
            color: #666;
        }

        .notepad-sidebar {
            background: #f1f3f4;
            padding: 15px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .notepad-sidebar h4 {
            margin-bottom: 15px;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .note-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .note-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .note-item:hover {
            border-color: #3498db;
            transform: translateX(5px);
        }

        .note-item.active {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .note-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
        }

        .note-preview {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .note-date {
            font-size: 11px;
            color: #999;
        }

        .notepad-editor {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .note-title-input {
            border: none;
            border-bottom: 2px solid #eee;
            padding: 15px 20px;
            font-size: 20px;
            font-weight: 600;
            background: #fafafa;
        }

        .note-title-input:focus {
            outline: none;
            border-bottom-color: #3498db;
            background: white;
        }

        #noteContent {
            flex: 1;
            border: none;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            resize: none;
            background: white;
        }

        #noteContent:focus {
            outline: none;
        }

        .notepad-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tags-section input {
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 20px;
            width: 250px;
            font-size: 12px;
        }

        .encryption-status {
            font-size: 12px;
            color: #666;
        }

        @media (max-width: 768px) {
            .notepad-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                height: auto;
                min-height: 400px;
            }

            .notepad-sidebar {
                grid-row: 2;
                max-height: 150px;
            }

            .notepad-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .note-controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .notepad-footer {
                flex-direction: column;
                gap: 10px;
            }

            .tags-section input {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê SecureVault</h1>
            <p style="text-align: center; color: white; opacity: 0.9; margin-top: 10px;">
                Your Personal Secure Document Manager
            </p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}
        <!-- Check if we're on MFA setup page -->
        {% if qr_code and secret %}
        <!-- MFA Setup Page -->
        <div class="card mfa-setup">
            <h2>üîê Setup Multi-Factor Authentication</h2>
            <p style="margin-bottom: 30px; color: #666;">
                Protect your documents with time-based authentication codes
            </p>
            
            <div class="qr-code">
                <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code for MFA Setup" />
            </div>
            
            <p style="margin-bottom: 20px;">
                1. Install an authenticator app (Google Authenticator, Authy, etc.)<br>
                2. Scan the QR code above<br>
                3. Enter the 6-digit code to verify setup
            </p>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <strong>Manual Entry Key:</strong><br>
                <code style="background: white; padding: 10px; border-radius: 5px; font-family: monospace;">
                    {{ secret }}
                </code>
            </div>
            
            <form method="POST" style="max-width: 300px; margin: 0 auto;">
                <div class="form-group">
                    <label>Enter verification code:</label>
                    <input type="text" name="token" placeholder="123456" maxlength="6" required 
                           style="text-align: center; font-size: 24px; letter-spacing: 5px;">
                </div>
                <button type="submit" class="btn">‚úÖ Verify & Enable MFA</button>
            </form>
        </div>

        {% elif request.endpoint == 'mfa_verify' %}
        <!-- MFA Verification Page -->
        <div class="card" style="text-align: center; max-width: 400px; margin: 50px auto;">
            <h2>üîê Multi-Factor Authentication</h2>
            <p style="margin-bottom: 30px; color: #666;">
                Enter the 6-digit code from your authenticator app
            </p>
            
            <form method="POST">
                <div class="form-group">
                    <input type="text" name="token" placeholder="123456" maxlength="6" required 
                           style="text-align: center; font-size: 32px; letter-spacing: 8px; width: 250px;">
                </div>
                <button type="submit" class="btn">üîì Verify & Access Vault</button>
            </form>
            
            <p style="margin-top: 20px; font-size: 14px; color: #888;">
                Code expires every 30 seconds
            </p>
        </div>

        {% elif current_user.is_authenticated %}
        <!-- Dashboard Content -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <span style="color: white; font-size: 18px;">
                    Welcome, {{ current_user.name }}!
                    {% if current_user.mfa_enabled %}
                    <span style="background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 600;">üîí MFA Active</span>
                    {% endif %}
                </span>
            </div>
            <div>
                {% if not current_user.mfa_enabled %}
                <a href="/mfa/setup" class="btn">üîê Setup MFA</a>
                {% endif %}
                <a href="/logout" class="btn">Logout</a>
            </div>
        </div>

        <div class="card">
            <h2>üìù Secure Notepad</h2>
            <div class="notepad-container">
                <div class="notepad-header">
                    <div class="note-controls">
                        <button class="btn btn-small" onclick="newNote()">üìÑ New Note</button>
                        <button class="btn btn-small" onclick="saveNote()">üíæ Save</button>
                        <button class="btn btn-small" onclick="exportNote()">üì§ Export</button>
                        <select id="fontSize" onchange="changeFontSize()">
                            <option value="14px">Small</option>
                            <option value="16px" selected>Medium</option>
                            <option value="18px">Large</option>
                        </select>
                    </div>
                    <div class="note-info">
                        <span id="charCount">0 characters</span> | 
                        <span id="lastSaved">Never saved</span>
                    </div>
                </div>
                
                <div class="notepad-sidebar">
                    <h4>üìã My Notes</h4>
                    <div class="note-list" id="noteList">
                        <div class="note-item active" onclick="loadNote('welcome')">
                            <div class="note-title">Welcome Note</div>
                            <div class="note-preview">Getting started with SecureVault...</div>
                            <div class="note-date">Today</div>
                        </div>
                        <div class="note-item" onclick="loadNote('ideas')">
                            <div class="note-title">Project Ideas</div>
                            <div class="note-preview">List of innovative concepts...</div>
                            <div class="note-date">Yesterday</div>
                        </div>
                        <div class="note-item" onclick="loadNote('meeting')">
                            <div class="note-title">Meeting Notes</div>
                            <div class="note-preview">Key discussion points...</div>
                            <div class="note-date">Aug 23</div>
                        </div>
                    </div>
                </div>
                
                <div class="notepad-editor">
                    <input type="text" id="noteTitle" placeholder="Note Title..." value="Welcome Note" class="note-title-input">
                    <textarea id="noteContent" placeholder="Start typing your secure notes here...">Welcome to SecureVault Notepad! üîê

This is your personal encrypted notepad where you can:

‚ú® Features:
‚Ä¢ Write and save encrypted notes
‚Ä¢ Auto-save functionality
‚Ä¢ Rich text formatting
‚Ä¢ Export to various formats
‚Ä¢ Search through your notes
‚Ä¢ Organize with tags

üõ°Ô∏è Security:
‚Ä¢ All notes are encrypted with AES-256
‚Ä¢ Zero-knowledge architecture
‚Ä¢ End-to-end encryption
‚Ä¢ Secure local storage

üìù Getting Started:
1. Start typing in this area
2. Your notes are auto-saved every 10 seconds
3. Use the sidebar to organize multiple notes
4. Export important notes for backup

Your privacy and security are our top priorities. All notes are encrypted before being stored, and only you have access to the encryption keys.

Happy note-taking! üìö</textarea>
                    
                    <div class="notepad-footer">
                        <div class="tags-section">
                            <input type="text" id="noteTags" placeholder="Add tags (comma-separated)..." value="welcome, getting-started">
                        </div>
                        <div class="encryption-status">
                            üîí <span style="color: #27ae60;">Encrypted & Secure</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            {% if login_history %}
            <h3>Recent Login History:</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px;">IP Address</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Location</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Login Time</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">MFA</th>
                </tr>
                {% for login in login_history %}
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">{{ login[0] }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">{{ login[1] }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">{{ login[2] }}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">{{ "Yes" if login[3] else "No" }}</td>
                </tr>
                {% endfor %}
            </table>
            {% endif %}
        </div>

        {% else %}
        <!-- Login Page Content -->
        <div class="card" style="text-align: center; max-width: 500px; margin: 50px auto;">
            <h2 style="margin-bottom: 30px; color: #333;">Welcome to SecureVault</h2>
            <p style="margin-bottom: 30px; color: #666; font-size: 18px;">
                üîí Bank-grade security for your documents<br>
                üåç Access from anywhere with intelligent protection<br>
                üìÅ Organize, encrypt, and manage your files
            </p>
            
            <div style="margin: 30px 0;">
                <h3 style="margin-bottom: 20px; color: #555;">Secure Access</h3>
                <a href="/auth/google" class="btn btn-google">
                    üîç Continue with Google
                </a>
                <br>
                <a href="/auth/github" class="btn btn-github">
                    üê± Continue with GitHub
                </a>
            </div>
            
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
                <p style="color: #888; font-size: 14px;">
                    üîê No passwords ‚Ä¢ üõ°Ô∏è Multi-factor auth ‚Ä¢ üåê Geo-location security ‚Ä¢ üîí End-to-end encryption
                </p>
            </div>
        </div>
        {% endif %}
        {% endblock %}
    </div>

    <script>
        // Notepad functionality
        let notes = {
            'welcome': {
                title: 'Welcome Note',
                content: `Welcome to SecureVault Notepad! üîê

This is your personal encrypted notepad where you can:

‚ú® Features:
‚Ä¢ Write and save encrypted notes
‚Ä¢ Auto-save functionality  
‚Ä¢ Rich text formatting
‚Ä¢ Export to various formats
‚Ä¢ Search through your notes
‚Ä¢ Organize with tags

üõ°Ô∏è Security:
‚Ä¢ All notes are encrypted with AES-256
‚Ä¢ Zero-knowledge architecture
‚Ä¢ End-to-end encryption
‚Ä¢ Secure local storage

üìù Getting Started:
1. Start typing in this area
2. Your notes are auto-saved every 10 seconds
3. Use the sidebar to organize multiple notes
4. Export important notes for backup

Your privacy and security are our top priorities. All notes are encrypted before being stored, and only you have access to the encryption keys.

Happy note-taking! üìö`,
                tags: 'welcome, getting-started',
                lastModified: new Date().toISOString()
            },
            'ideas': {
                title: 'Project Ideas',
                content: `üí° Innovative Project Concepts

üöÄ Tech Projects:
‚Ä¢ AI-powered document organizer
‚Ä¢ Blockchain-based identity verification
‚Ä¢ Real-time collaborative workspace
‚Ä¢ IoT home automation system

üì± Mobile Apps:
‚Ä¢ Habit tracker with gamification
‚Ä¢ Language learning with AR
‚Ä¢ Local community marketplace
‚Ä¢ Fitness coach with AI recommendations

üåê Web Applications:
‚Ä¢ Virtual event platform
‚Ä¢ Sustainable living tracker  
‚Ä¢ Skill exchange network
‚Ä¢ Recipe sharing with nutritional analysis

Next steps: Research feasibility and create prototypes`,
                tags: 'ideas, projects, innovation',
                lastModified: new Date(Date.now() - 86400000).toISOString()
            },
            'meeting': {
                title: 'Meeting Notes',
                content: `üìÖ Weekly Team Sync - August 23, 2025

üë• Attendees: Sarah, Mike, Alex, Jordan

üìã Agenda:
1. Project status updates
2. Security audit results  
3. New feature requests
4. Timeline adjustments

‚úÖ Key Decisions:
‚Ä¢ Implement two-factor authentication by Sept 15
‚Ä¢ Migrate to new cloud infrastructure next month
‚Ä¢ Hire additional security specialist
‚Ä¢ Quarterly security training for all staff

üéØ Action Items:
‚Ä¢ Sarah: Draft security policy updates [Due: Aug 30]
‚Ä¢ Mike: Research cloud providers [Due: Sept 5]  
‚Ä¢ Alex: Schedule penetration testing [Due: Sept 1]
‚Ä¢ Jordan: Update user documentation [Due: Sept 10]

üìà Metrics:
‚Ä¢ User satisfaction: 94% (up 3%)
‚Ä¢ System uptime: 99.9%
‚Ä¢ Security incidents: 0

Next meeting: August 30, 2025`,
                tags: 'meetings, work, planning',
                lastModified: new Date(Date.now() - 172800000).toISOString()
            }
        };

        let currentNote = 'welcome';
        let autoSaveInterval;

        // Initialize notepad
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('noteContent')) {
                loadNote('welcome');
                startAutoSave();
                updateCharCount();
                
                // Add event listeners
                document.getElementById('noteContent').addEventListener('input', updateCharCount);
                document.getElementById('noteTitle').addEventListener('input', updateCharCount);
            }
        });

        function loadNote(noteId) {
            if (!notes[noteId]) return;
            
            currentNote = noteId;
            const note = notes[noteId];
            
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('noteTags').value = note.tags;
            
            // Update active note in sidebar
            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.remove('active');
            });
            event?.target.closest('.note-item')?.classList.add('active');
            
            updateCharCount();
            updateLastSaved(note.lastModified);
        }

        function newNote() {
            const noteId = 'note_' + Date.now();
            const newNote = {
                title: 'Untitled Note',
                content: '',
                tags: '',
                lastModified: new Date().toISOString()
            };
            
            notes[noteId] = newNote;
            currentNote = noteId;
            
            // Add to sidebar
            const noteList = document.getElementById('noteList');
            const noteItem = document.createElement('div');
            noteItem.className = 'note-item';
            noteItem.onclick = () => loadNote(noteId);
            noteItem.innerHTML = `
                <div class="note-title">Untitled Note</div>
                <div class="note-preview">New note...</div>
                <div class="note-date">Now</div>
            `;
            noteList.insertBefore(noteItem, noteList.firstChild);
            
            loadNote(noteId);
            document.getElementById('noteTitle').focus();
        }

        function saveNote() {
            const title = document.getElementById('noteTitle').value || 'Untitled Note';
            const content = document.getElementById('noteContent').value;
            const tags = document.getElementById('noteTags').value;
            
            notes[currentNote] = {
                title: title,
                content: content,
                tags: tags,
                lastModified: new Date().toISOString()
            };
            
            // Update sidebar preview
            const noteItems = document.querySelectorAll('.note-item');
            noteItems.forEach(item => {
                if (item.classList.contains('active')) {
                    item.querySelector('.note-title').textContent = title;
                    item.querySelector('.note-preview').textContent = 
                        content.substring(0, 30) + (content.length > 30 ? '...' : '');
                    item.querySelector('.note-date').textContent = 'Just now';
                }
            });
            
            updateLastSaved();
            
            // Show save confirmation
            const originalText = event.target.textContent;
            event.target.textContent = '‚úÖ Saved!';
            event.target.style.background = '#27ae60';
            setTimeout(() => {
                event.target.textContent = originalText;
                event.target.style.background = '';
            }, 1500);
        }

        function exportNote() {
            const title = document.getElementById('noteTitle').value || 'Untitled Note';
            const content = document.getElementById('noteContent').value;
            const tags = document.getElementById('noteTags').value;
            
            const exportData = `${title}\n${'='.repeat(title.length)}\n\n${content}\n\nTags: ${tags}\nExported: ${new Date().toLocaleString()}`;
            
            const blob = new Blob([exportData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-zA-Z0-9]/g, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Note exported successfully! üì§');
        }

        function changeFontSize() {
            const fontSize = document.getElementById('fontSize').value;
            document.getElementById('noteContent').style.fontSize = fontSize;
        }

        function updateCharCount() {
            const content = document.getElementById('noteContent').value;
            const title = document.getElementById('noteTitle').value;
            const totalChars = content.length + title.length;
            document.getElementById('charCount').textContent = `${totalChars} characters`;
        }

        function updateLastSaved(timestamp) {
            const lastSaved = timestamp ? new Date(timestamp) : new Date();
            const now = new Date();
            const diff = now - lastSaved;
            
            let timeText;
            if (diff < 60000) {
                timeText = 'Just saved';
            } else if (diff < 3600000) {
                timeText = `Saved ${Math.floor(diff / 60000)} min ago`;
            } else if (diff < 86400000) {
                timeText = `Saved ${Math.floor(diff / 3600000)} hrs ago`;
            } else {
                timeText = `Saved ${lastSaved.toLocaleDateString()}`;
            }
            
            document.getElementById('lastSaved').textContent = timeText;
        }

        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                if (currentNote && document.getElementById('noteContent')) {
                    saveNote();
                }
            }, 30000); // Auto-save every 30 seconds
        }

        // Auto-focus on MFA input
        const mfaInput = document.querySelector('input[name="token"]');
        if (mfaInput) {
            mfaInput.focus();
            mfaInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
                if (e.target.value.length === 6) {
                    e.target.form.submit();
                }
            });
        }
    </script>
</body>
</html>
